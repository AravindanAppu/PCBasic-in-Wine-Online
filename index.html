<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PC-BASIC in Browser Terminal</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm/css/xterm.css" />
  <style>
    body, html {
      height: 100%;
      margin: 0;
    }
    #terminal {
      height: 100vh;
      width: 100vw;
    }
  </style>
</head>
<body>
  <div id="terminal"></div>

  <!-- xterm.js -->
  <script src="https://cdn.jsdelivr.net/npm/xterm/lib/xterm.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit/lib/xterm-addon-fit.js"></script>

  <!-- Pyodide -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>

  <script>
    const term = new Terminal();
    const fitAddon = new window.TerminalAddonFit.FitAddon();
    term.loadAddon(fitAddon);
    term.open(document.getElementById('terminal'));
    fitAddon.fit();

    let pyodideReady = false;
    let pyodide;

    (async () => {
      term.writeln("Loading Pyodide...");
      pyodide = await loadPyodide();
      await pyodide.loadPackage("micropip");
      term.writeln("Pyodide loaded.");

      // Install PCBASIC via pip
      term.writeln("Installing PCBASIC...");
      await pyodide.runPythonAsync(`
        import micropip
        await micropip.install("pcbasic")
        print("PCBASIC installed.")
      `);

      pyodideReady = true;
      term.writeln("Type 'runbasic' to start PC-BASIC.");
    })();

    // Handle user input
    term.onKey((data) => {
      const input = data.key;

      if (input === '\r') { // Enter key
        const line = term._core.buffer.lines.get(term._core.buffer.ybase + term._core.buffer.y).translateToString();
        handleCommand(line.trim());
      } else if (input === '\x7F') { // Backspace
        if (term._core.buffer.x > 0) {
          term._core.buffer.x--;
          term._core.buffer.lines.get(term._core.buffer.ybase + term._core.buffer.y).setCell(term._core.buffer.x, { ch: ' ', fg: null, bg: null, chWidth: 1 });
          term.refresh(term._core.buffer.y, term._core.buffer.y);
        }
      } else {
        term.write(data.key);
      }
    });

    async function handleCommand(command) {
      term.writeln(""); // New line

      if (!pyodideReady) {
        term.writeln("Still loading... Please wait.");
        return;
      }

      if (command === "runbasic") {
        term.writeln("Starting PC-BASIC...");
        try {
          const result = await pyodide.runPythonAsync(`
            import subprocess
            result = subprocess.run(['pcbasic', '--interactive'], capture_output=True, text=True, input='10 PRINT "HELLO BASIC"\\n20 GOTO 10\\nRUN\\n')
            result.stdout
          `);
          term.writeln(result);
        } catch (err) {
          term.writeln("Error: " + err);
        }
      } else {
        term.writeln("Unknown command. Try: runbasic");
      }

      term.write("$ ");
    }
  </script>
</body>
</html>
