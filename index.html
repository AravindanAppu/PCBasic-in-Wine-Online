<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>PC-BASIC via Pyodide</title>
  <style>
    body { background:#000; color:#0f0; font-family:monospace; margin:0; }
    #terminal { white-space: pre-wrap; padding:10px; height:80vh;
                overflow-y:auto; border-bottom:1px solid #0f0; }
    #inputline { width:100%; background:#111; color:#0f0; border:none;
                 padding:5px; font-family:monospace; }
  </style>
</head>
<body>
  <div id="terminal"></div>
  <input id="inputline" placeholder="Type here & press Enterâ€¦" autofocus />
  
  <script type="module">
    import { loadPyodide } from "https://cdn.jsdelivr.net/pyodide/v0.24.0/full/pyodide.mjs";
    const term = document.getElementById("terminal");
    const input = document.getElementById("inputline");

    function printToTerm(txt) {
      term.textContent += txt;
      term.scrollTop = term.scrollHeight;
    }

    // Start Pyodide
    const pyodide = await loadPyodide({
      stdout: txt => printToTerm(txt + "\n"),
      stderr: txt => printToTerm("\nERR: " + txt + "\n")
    });
    await pyodide.loadPackage("micropip");

    // Install pcbasic wheel
    await pyodide.runPythonAsync(`
import micropip
await micropip.install('/pcbasic-2.0.7-py2.py3-none-any.whl')
print("PC-BASIC installed.")
`);

    // Copy a BASIC program from server
    const demo = await fetch("basic/ALLFOOT.BAS").then(r => r.text());
    pyodide.FS.writeFile("ALLFOOT.BAS", demo);

    // Hook input() to browser
    await pyodide.runPythonAsync(`
import sys, builtins, time
_input_buffer = []
def js_input(prompt=""):
    sys.stdout.write(prompt); sys.stdout.flush()
    while not _input_buffer: time.sleep(0.05)
    return _input_buffer.pop(0)
builtins.input = js_input
`);

    input.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        const val = input.value;
        printToTerm(val + "\\n");
        pyodide.runPython(\`_input_buffer.insert(0, "\${val}")\`);
        input.value = "";
      }
    });

    // Run PC-BASIC in text-only mode
    await pyodide.runPythonAsync(`
import sys, pcbasic
sys.argv = ["pcbasic", "ALLFOOT.BAS", "--text-only"]
try:
    pcbasic.main()
except SystemExit:
    pass
`);
    printToTerm("\\n[PC-BASIC session ended]\\n");
  </script>
</body>
</html>
