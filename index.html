<script type="module">
  emulators.pathPrefix = "https://v8.js-dos.com/latest/emulators/";
  
  const canvas = document.getElementById("dos-root");
  const status = document.getElementById("status");
  
  let currentEmulator = null;
  let shiftActive = false;

  function updateStatus(message) {
    status.textContent = message;
  }

  function hideStatus() {
    status.style.display = 'none';
  }

  // --- Improved resizeCanvas for crisp, correct aspect ratio ---
  function resizeCanvas() {
    // 320x200 DOS screen (aspect 16:10)
    const container = document.getElementById('screen-container');
    const w = container.offsetWidth;
    const h = container.offsetHeight;
    let newWidth = w;
    let newHeight = w * 200 / 320;
    if (newHeight > h) {
      newHeight = h;
      newWidth = h * 320 / 200;
    }
    // Set both CSS and actual canvas size
    canvas.style.width = newWidth + "px";
    canvas.style.height = newHeight + "px";
    canvas.width = Math.round(newWidth);
    canvas.height = Math.round(newHeight);
  }

  window.addEventListener('resize', resizeCanvas);
  resizeCanvas();

  async function runGWBasic() {
    try {
      updateStatus("Loading GW-BASIC...");
      const bundle = await fetch("./basic.jsdos");
      if (!bundle.ok) throw new Error(`Failed to load basic.jsdos: ${bundle.status}`);
      const ci = await emulators.dosboxXWorker(new Uint8Array(await bundle.arrayBuffer()));
      currentEmulator = ci;
      const ctx = canvas.getContext('2d');
      const rgba = new Uint8ClampedArray(320 * 200 * 4);

      // Extra: set all smoothing flags for maximum compatibility
      ctx.imageSmoothingEnabled = false;
      ctx.mozImageSmoothingEnabled = false;
      ctx.webkitImageSmoothingEnabled = false;
      ctx.msImageSmoothingEnabled = false;

      ci.events().onFrame((rgb, _rgba) => {
        for (let next = 0; next < 320 * 200; ++next) {
          rgba[next * 4 + 0] = rgb[next * 3 + 0];
          rgba[next * 4 + 1] = rgb[next * 3 + 1];
          rgba[next * 4 + 2] = rgb[next * 3 + 2];
          rgba[next * 4 + 3] = 255;
        }
        const imageData = new ImageData(rgba, 320, 200);

        // Ensure no smoothing every frame
        ctx.imageSmoothingEnabled = false;
        ctx.mozImageSmoothingEnabled = false;
        ctx.webkitImageSmoothingEnabled = false;
        ctx.msImageSmoothingEnabled = false;
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = 320;
        tempCanvas.height = 200;
        const tempCtx = tempCanvas.getContext('2d');
        tempCtx.putImageData(imageData, 0, 0);

        ctx.drawImage(tempCanvas, 0, 0, 320, 200, 0, 0, canvas.width, canvas.height);
      });

      hideStatus();
    } catch (error) {
      console.error("Error loading GW-BASIC:", error);
      updateStatus("Error: " + error.message);
    }
  }

  // ... rest of your code unchanged ...
  // Virtual keyboard functions...
  // Start GW-BASIC
  runGWBasic();
</script>
